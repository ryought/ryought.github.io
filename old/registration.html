<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1, user-scalable=no">
    <meta name="author" content="ryought">
    <meta name="description" content="ryought::lab | ryought - Ryo Nakabayashi | UTbioinfo B3">
    <!-- Use the title from a page's frontmatter if it has one -->
    <title>page - ryought::lab</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
      });
    </script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link href="css/site.css" rel="stylesheet" />
    <script src="js/site.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">ryought::lab</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home <span class="sr-only">(current)</span></a></li>
        <li><a href="test.html">Logs</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Product <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="product.html">一覧</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="hashpass.html">Hashpass</a></li>
            <li><a href="#">時間割追加 gcal-timetabler</a></li>
            <li><a href="icons.html">アイコン集</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">BioInfo</li>
            <li><a href="#">Separated link</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="#">More Codes</a></li>
          </ul>
        </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

    
    <div class="container">
      <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>ICF申し込み</title>
  <script src="https://unpkg.com/vue"></script>
  <script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js"></script>
  <script src="https://unpkg.com/vuefire/dist/vuefire.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.9/semantic.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.9/semantic.min.js"></script>
</head>
<body>
  <div id="app">
    <div>
      <input type="text" v-model="email" placeholder="email">
      <button v-on:click="registerEmail">Register</button>
    </div>
      {{ message }}
    <div>
      <input type="text" v-model="code" placeholder="code">
      <button v-on:click="verify">Verify Email</button>
    </div>
    <div v-if="isMailVerified">
      {{ user.uid }} {{ email }}
      name <input type="text" v-model="user.name" placeholder="name">
      place <input type="text" v-model="user.place" placeholder="place">
      <button v-on:click="apply">Apply</button>
    </div>

  <div class="ui container">
  <form class="ui form segment">
    <div class="two fields">
      <div class="field">
        <label>姓</label>
        <input placeholder="firstname" name="firstname" type="text">
      </div>
      <div class="field">
        <label>名</label>
        <input placeholder="lastname" name="lastname" type="text">
      </div>
    </div>
    <div class="two fields">
      <div class="field">
        <label>メールアドレス</label>
        <input placeholder="Email" name="email" type="text">
      </div>
      <div class="field">
        <label>メールアドレス(確認)</label>
        <input placeholder="Email" name="emailag" type="text">
      </div>
    </div>
    <div class="field">
      <label>楽器</label>
      <select name="skills" multiple="" class="ui fluid dropdown">
        <option value="">Select Skills</option>
        <option value="css">CSS</option>
        <option value="html">HTML</option>
        <option value="javascript">Javascript</option>
        <option value="design">Graphic Design</option>
        <option value="plumbing">Plumbing</option>
        <option value="mech">Mechanical Engineering</option>
        <option value="repair">Kitchen Repair</option>
      </select>
    </div>
    <div class="ui primary submit button">フォーム請求</div>
    <div class="ui error message"></div>
  </form>
  </div>

      <script type="text/javascript">
        $('.ui.dropdown').dropdown();
        $('.ui.form')
          .form({
            fields: {
              firstname     : 'empty',
              lastname   : 'empty',
              username : 'empty',
              password : ['minLength[6]', 'empty'],
              skills   : ['minCount[2]', 'empty'],
              email    : 'empty',
              emailag  : ['empty', 'match[email]'],
              terms    : 'checked'
            }
          });
      </script>
  </div>

  <script>
    // setup Firebase
    var config = {
      apiKey: "AIzaSyCJ5-wGuwje-5LqhpMNgs3SUbyil3V3WMI",
      authDomain: "icf-09-registration.firebaseapp.com",
      databaseURL: "https://icf-09-registration.firebaseio.com",
      projectId: "icf-09-registration",
      storageBucket: "icf-09-registration.appspot.com",
      messagingSenderId: "385260940809"
    };
    firebase.initializeApp(config);

    var app = new Vue({
      el: '#app',
      data: {
        user: {
          uid: '',
          pass: '',
          name: '',
          place: '',
        },
        email: '',
        message: '',
        code: '',
        isMailVerified: false,
        isLoggedIn: false,
      },

      firebase: {
        user: null
      },

      methods: {
        apply: function() {
          firebase.database().ref('users/' + this.user.uid).set(this.user);
        },
        registerEmail: function() {
          // emailに確認メール送信
          let self = this;
          firebase.auth().createUserWithEmailAndPassword(self.email, self.generatePass())
            .then(function() {
              firebase.auth().sendPasswordResetEmail(self.email).then(function() {
                self.message = 'check email and click link';
              })
            })
            .catch(function(error) {
              console.log(error);
              if(error.code==='auth/email-already-in-use'){
                firebase.auth().sendPasswordResetEmail(self.email).then(function() {
                  self.message = 'resent email';
                })
              }
            });
        },
        generatePass: function() {
          // パスワード生成
          let chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
          let pass = '';
          for(let i=0; i<16; i++) {
            pass += chars[Math.floor(Math.random() * chars.length)];
          }
          return pass;
        },
        verify: function() {
          let self = this;
          firebase.auth().verifyPasswordResetCode(self.code)
            .then(function(email) {
              console.log(email);
              self.email = email;
              self.password = self.generatePass();
              firebase.auth().confirmPasswordReset(self.code, self.password)
                .then(function() {
                  // メール認証成功
                  self.isMailVerified = true;
                  firebase.auth().signInWithEmailAndPassword(self.email, self.password)
                    .then(function() {
                      let user = firebase.auth().currentUser;
                      if(user) {
                        self.isLoggedIn = true;
                        self.user.uid = user.uid;
                      }
                    })
                    .catch(function() {
                      self.isLoggedIn = false;
                    });
                });
            })
            .catch(function(error) {
              console.log(error);
              if(error.code==='auth/invalid-action-code') {
                self.message = 'please re-enter email';
              }
            });
        },
      }
    })
  </script>
</body>
</html>

    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  </body>
</html>
